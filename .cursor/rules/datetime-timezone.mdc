---
description: Date/time and timezone handling standards
globs: ["**/lib/queries/**/*.ts", "**/lib/actions/**/*.ts", "**/components/**/date*.tsx", "**/components/**/time*.tsx"]
alwaysApply: false
---

# Date/Time and Timezone Handling

## Use Business Timezone for All Date Operations

When working with dates and times in booking/scheduling systems, always use the business's timezone (not UTC or server timezone) to ensure consistent time display regardless of server location or user timezone.

### Rule: Define Business Timezone Constant

Always define the business timezone at the top of files that handle dates:

```typescript
import { toZonedTime, fromZonedTime } from "date-fns-tz"

const BUSINESS_TIMEZONE = "America/Toronto"  // or appropriate timezone
```

### Rule: Server-Side Date Construction

When creating Date objects from database time strings on the server, convert from business timezone to UTC:

```typescript
// ❌ BAD - timezone-dependent
const dateStr = "2026-02-25"
const startOfDay = new Date(`${dateStr}T00:00:00`)  // Server's local timezone

// ❌ ALSO BAD - forces UTC but loses business timezone context
const startOfDay = new Date(`${dateStr}T00:00:00Z`)  // UTC (wrong for business time)

// ✅ GOOD - convert from business timezone to UTC
const startOfDay = fromZonedTime(`${dateStr}T00:00:00`, BUSINESS_TIMEZONE)
const timeSlot = fromZonedTime(`${dateStr}T08:00:00`, BUSINESS_TIMEZONE)
```

### Rule: Store and Transmit in ISO Format (UTC)

When returning dates from server functions, use `.toISOString()` which returns UTC:

```typescript
// ✅ GOOD - dates are stored/transmitted as UTC
return {
  startTime: slot.toISOString(),  // "2026-02-25T13:00:00.000Z" (8 AM Toronto = 1 PM UTC)
  endTime: slotEnd.toISOString(),
}
```

### Rule: Display in Business Timezone on Client

On the client, convert UTC times back to business timezone for display (not user's local timezone):

```typescript
// ❌ BAD - displays in user's local timezone
{format(new Date(slot.startTime), "h:mm a")}

// ✅ GOOD - displays in business timezone
import { toZonedTime } from "date-fns-tz"
const BUSINESS_TIMEZONE = "America/Toronto"

{format(toZonedTime(new Date(slot.startTime), BUSINESS_TIMEZONE), "h:mm a")}
```

## Why This Matters

**Problem:** Production server and development machine are in different timezones:
- Dev machine in Toronto: "08:00" parsed as 8 AM local (Toronto) → displays correctly as 8 AM
- Production server in Europe: "08:00" parsed as 8 AM local (Europe) → converted to UTC → displays wrong time
- This causes times to appear differently (e.g., 4:00 AM in production vs 8:00 AM in dev)

**Solution:** Always use the business timezone for parsing and display:
- Server: Parse "08:00" as 8 AM Toronto time → convert to UTC for storage
- Client: Convert UTC back to Toronto time → everyone sees 8 AM regardless of their location

## Common Patterns

### Database Queries with Date Ranges

```typescript
import { fromZonedTime } from "date-fns-tz"

const BUSINESS_TIMEZONE = "America/Toronto"
const dateStr = format(date, "yyyy-MM-dd")

const startOfDay = fromZonedTime(`${dateStr}T00:00:00`, BUSINESS_TIMEZONE)
const endOfDay = fromZonedTime(`${dateStr}T23:59:59`, BUSINESS_TIMEZONE)

const bookings = await db.booking.findMany({
  where: {
    startTime: { gte: startOfDay, lte: endOfDay }
  }
})
```

### Working Hours and Time Slots

```typescript
// If workingHours.startTime is "08:00" from DB (business local time)
import { fromZonedTime } from "date-fns-tz"

const BUSINESS_TIMEZONE = "America/Toronto"
const dateStr = format(date, "yyyy-MM-dd")

const startTime = fromZonedTime(`${dateStr}T${workingHours.startTime}:00`, BUSINESS_TIMEZONE)
const endTime = fromZonedTime(`${dateStr}T${workingHours.endTime}:00`, BUSINESS_TIMEZONE)
```

### Client Display with Business Timezone

```typescript
// Client component
import { toZonedTime } from "date-fns-tz"
import { format } from "date-fns"

const BUSINESS_TIMEZONE = "America/Toronto"

function TimeSlotButton({ slot }) {
  return (
    <button>
      {format(toZonedTime(new Date(slot.startTime), BUSINESS_TIMEZONE), "h:mm a")}
    </button>
  )
}
```

### Comparing Times

Date objects in JavaScript are always stored as UTC timestamps internally, so comparisons work correctly:

```typescript
if (isAfter(currentSlot, now)) {
  // Safe - both are Date objects (UTC internally)
}
```
